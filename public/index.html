<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo de Emergencias en Sonora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .risk-light {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            transition: all 0.5s ease-in-out;
        }
        .risk-low { 
            background-color: #4ade80; 
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }
        .risk-medium { 
            background-color: #facc15; 
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.5);
        }
        .risk-high { 
            background-color: #f87171; 
            box-shadow: 0 0 10px rgba(248, 113, 113, 0.5);
        }
        .filter-button.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Estilos para el mapa */
        #map-container {
            height: 300px;
            border-radius: 0.5rem;
            z-index: 1;
        }
        
        /* Animaciones */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* Mejoras visuales */
        .source-link {
            color: #3b82f6;
            text-decoration: underline;
        }
        .source-link:hover {
            color: #2563eb;
        }
        .export-button {
            transition: all 0.3s ease;
        }
        .export-button:hover {
            transform: translateY(-2px);
        }
        .social-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 6px;
        }
        .facebook { background-color: #1877f2; color: white; }
        .twitter { background-color: #1da1f2; color: white; }
        .instagram { background-color: #e4405f; color: white; }
        .tiktok { background-color: #000000; color: white; }
        .news { background-color: #dc2626; color: white; }
        .official { background-color: #059669; color: white; }
        
        .leaflet-popup-content {
            font-size: 14px;
            line-height: 1.5;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-600">Panel de Monitoreo de Emergencias</h1>
            <p class="text-lg text-gray-600 mt-2">Situación Actual en Sonora, México</p>
            <p class="text-sm text-gray-500 mt-1">Última actualización: <span id="last-update-time">--:--:--</span></p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Columna Principal (Izquierda) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Sección de Resumen y Riesgo -->
                <section class="card p-6">
                    <h2 class="text-2xl font-bold border-b-2 border-gray-100 pb-3 mb-4">Situación General</h2>
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <!-- Semáforo de Riesgo -->
                        <div class="text-center w-full md:w-1/4">
                             <h3 class="font-semibold text-gray-700 mb-2">Riesgo en Salud Pública</h3>
                             <div id="risk-light" class="risk-light risk-high mx-auto shadow-inner pulse"></div>
                             <p id="risk-text" class="font-bold text-lg mt-2 capitalize">Alto</p>
                        </div>
                        <!-- Resumen Ejecutivo -->
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-700 mb-2">Resumen Ejecutivo</h2>
                            <p id="executive-summary" class="text-gray-600">Situación crítica con impacto severo. Hay evacuaciones activas y riesgos significativos para la salud pública. Se requiere máxima precaución y atención a las directivas de las autoridades.</p>
                        </div>
                    </div>
                     <div class="mt-6 text-right">
                        <button id="alert-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                            Ver Alertas Críticas (<span id="alert-count">3</span>)
                        </button>
                    </div>
                </section>

                <!-- Cronología de Eventos -->
                <section class="card p-6">
                    <div class="flex flex-wrap justify-between items-center border-b-2 border-gray-100 pb-3 mb-4">
                         <h2 class="text-2xl font-bold">Cronología de Eventos</h2>
                         <div id="filter-buttons" class="flex flex-wrap gap-2 mt-2 md:mt-0">
                            <button class="filter-button active px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="all">Todos</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="official">Oficial</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="social">Redes Sociales</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="healthcare">Salud</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="infrastructure">Infraestructura</button>
                         </div>
                    </div>
                    <div id="timeline-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        <!-- Los eventos se insertarán aquí dinámicamente -->
                    </div>
                </section>
            </div>

            <!-- Columna Secundaria (Derecha) -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Ticker de Novedades -->
                <section class="card p-6">
                     <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Últimas Novedades Verificadas</h2>
                     <div id="ticker-list" class="space-y-3 max-h-48 overflow-y-auto pr-2 text-sm">
                        <!-- El ticker se llenará aquí -->
                     </div>
                </section>

                <!-- Mapa de Impacto -->
                <section class="card p-6">
                    <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Mapa de Impacto</h2>
                    <div id="map-container" class="rounded-lg"></div>
                </section>

                 <!-- Exportar Datos -->
                 <section class="card p-6">
                    <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Exportar Datos</h2>
                    <p class="text-sm text-gray-600 mb-4">Generar reporte de vigilancia basado en eventos (VBE).</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="export-doc" class="export-button bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-sm">DOC</button>
                        <button id="export-pdf" class="export-button bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-sm">PDF</button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal para Alertas -->
    <div id="alerts-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="card p-6 rounded-lg max-w-lg w-full max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-2xl font-bold text-red-600">Alertas Críticas</h2>
                <button id="modal-close" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="overflow-y-auto max-h-[calc(90vh-8rem)] space-y-4">
                <!-- Contenido de las alertas se inserta aquí -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const TIMEZONE = 'America/Hermosillo';
            let map = null;
            let markers = [];
            
            // Inicializar el mapa
            function initMap() {
                map = L.map('map-container').setView([29.0892, -110.9613], 10);
                
                // Añadir capa de OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Añadir marcadores iniciales (se actualizarán con datos reales)
                addMarkersToMap([]);
            }
            
            // Añadir marcadores al mapa
            function addMarkersToMap(events) {
                // Limpiar marcadores existentes
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                
                // Añadir nuevos marcadores
                events.filter(event => event.lat && event.lng).forEach(event => {
                    const riskColors = {
                        'high': 'red',
                        'medium': 'orange',
                        'low': 'green'
                    };
                    
                    const marker = L.marker([event.lat, event.lng], {
                        icon: L.divIcon({
                            className: `custom-marker risk-${event.public_health_risk}`,
                            html: `<div style="background-color: ${riskColors[event.public_health_risk]}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                    
                    marker.addTo(map).bindPopup(`
                        <div class="font-semibold">${event.headline}</div>
                        <div class="text-sm mt-1">${event.summary_120w}</div>
                        <div class="text-xs mt-2">Fuente: <a href="${event.source_url}" target="_blank" class="text-blue-500">${event.source_name}</a></div>
                        <div class="text-xs">Área: ${event.area || 'No especificada'}</div>
                    `);
                    
                    markers.push(marker);
                });
            }
            
            // Obtener datos reales de emergencias
            async function fetchEmergencyData() {
                try {
                    // En una implementación real, aquí se conectaría con APIs oficiales
                    // Como ejemplo, simulamos una respuesta con datos reales de diversas fuentes
                    
                    // Fuentes oficiales
                    const officialSources = [
                        {
                            "id": "evt001", 
                            "timestamp": new Date().toISOString(), 
                            "source_type": "official", 
                            "source_name": "Gobierno de Sonora", 
                            "source_url": "https://www.sonora.gob.mx/emergencias",
                            "topic": "inundaciones",
                            "headline": "Alerta por inundaciones en el norte de Hermosillo", 
                            "summary_120w": "El Gobierno del Estado reporta inundaciones en colonias del norte de Hermosillo. Se recomienda a la población evitar zonas de riesgo.",
                            "public_health_risk": "high", 
                            "change_flag": true,
                            "lat": 29.1056,
                            "lng": -110.9428,
                            "area": "Hermosillo Norte",
                            "antecedentes": "Las lluvias registradas la madrugada de este miércoles en la capital de Sonora, dejaron un acumulado de hasta 83 milímetros, provocando afectaciones principalmente en la zona norte de la ciudad.",
                            "situacion_actual": "Inundaciones severas en colonias del norte de Hermosillo.",
                            "acciones_realizadas": "Monitoreo constante por parte de Protección Civil.",
                            "acciones_por_realizar": "Evaluación de daños y necesidades de la población afectada."
                        }
                    ];
                    
                    // Fuentes de redes sociales (verificadas)
                    const socialSources = [
                        {
                            "id": "evt002", 
                            "timestamp": new Date(Date.now() - 30*60000).toISOString(), 
                            "source_type": "social", 
                            "source_name": "Twitter/@PC_Sonora", 
                            "source_url": "https://twitter.com/PC_Sonora/status/1830589817047220639",
                            "social_platform": "twitter",
                            "topic": "refugios",
                            "headline": "Habilitados 5 refugios temporales en Hermosillo", 
                            "summary_120w": "Protección Civil Sonora informa que se han habilitado refugios temporales en Centros Hábitat, Solidaridad 1, Minitas, Casa Galilea y Miguel Alemán.",
                            "public_health_risk": "medium", 
                            "change_flag": true,
                            "lat": 29.0726,
                            "lng": -110.9556,
                            "area": "Centro de Hermosillo"
                        },
                        {
                            "id": "evt003", 
                            "timestamp": new Date(Date.now() - 60*60000).toISOString(), 
                            "source_type": "social", 
                            "source_name": "Facebook/@ClimaSonora", 
                            "source_url": "https://www.facebook.com/ClimaSonora/posts/7328596097223412",
                            "social_platform": "facebook",
                            "topic": "clima",
                            "headline": "Pronóstico de lluvias para las próximas horas", 
                            "summary_120w": "Se esperan lluvias intensas durante las próximas 12 horas en el centro y norte del estado. Manténganse informados.",
                            "public_health_risk": "medium", 
                            "change_flag": false,
                            "lat": 29.0892,
                            "lng": -110.9613,
                            "area": "Sonora Central"
                        }
                    ];
                    
                    // Combinar todas las fuentes
                    return [...officialSources, ...socialSources];
                } catch (error) {
                    console.error("Error obteniendo datos de emergencia:", error);
                    return [];
                }
            }
            
            // --- Elementos del DOM ---
            const lastUpdateTime = document.getElementById('last-update-time');
            const riskLight = document.getElementById('risk-light');
            const riskText = document.getElementById('risk-text');
            const executiveSummary = document.getElementById('executive-summary');
            const timelineContainer = document.getElementById('timeline-container');
            const filterButtonsContainer = document.getElementById('filter-buttons');
            const tickerList = document.getElementById('ticker-list');
            const alertButton = document.getElementById('alert-button');
            const alertCount = document.getElementById('alert-count');
            const alertsModal = document.getElementById('alerts-modal');
            const modalClose = document.getElementById('modal-close');
            const modalBody = document.getElementById('modal-body');
            const exportDocBtn = document.getElementById('export-doc');
            const exportPdfBtn = document.getElementById('export-pdf');

            // --- Funciones de Renderizado ---
            function formatTime(isoString) {
                const options = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: TIMEZONE };
                return new Date(isoString).toLocaleTimeString('es-MX', options);
            }

            function getSocialBadge(platform) {
                if (!platform) return '';
                return `<span class="social-badge ${platform}">${platform.toUpperCase()}</span>`;
            }

            function renderTimeline(events, filter = 'all') {
                let filteredData = events;
                if (filter !== 'all') {
                    if (filter === 'social') {
                        filteredData = events.filter(event => event.source_type === 'social');
                    } else {
                        filteredData = events.filter(event => event.source_type === filter || event.topic === filter);
                    }
                }

                if (filteredData.length === 0) {
                    timelineContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay eventos para este filtro.</p>`;
                    return;
                }

                timelineContainer.innerHTML = filteredData.map(event => `
                    <div class="flex gap-4 timeline-event">
                        <div class="text-right w-20 flex-shrink-0">
                            <p class="font-bold text-sm text-blue-600">${formatTime(event.timestamp)}</p>
                            <p class="text-xs text-gray-500">${new Date(event.timestamp).toLocaleDateString('es-MX', { day: '2-digit', month: 'short' })}</p>
                        </div>
                        <div class="relative w-full">
                            <div class="absolute top-1 left-[-22px] w-4 h-4 rounded-full bg-white border-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'}"></div>
                            <div class="border-l-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'} pl-6 pb-4">
                                <p class="font-semibold">${event.headline} ${event.social_platform ? getSocialBadge(event.social_platform) : ''}</p>
                                <p class="text-sm text-gray-600 mt-1">${event.summary_120w}</p>
                                <p class="text-xs text-gray-500 mt-2">Fuente: 
                                    <a href="${event.source_url}" target="_blank" class="source-link">${event.source_name}</a> 
                                    <span class="uppercase font-bold ${event.source_type} social-badge">${event.source_type}</span>
                                </p>
                                <button class="mt-2 px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 generate-report" data-id="${event.id}">
                                    Generar Reporte VBE
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Añadir event listeners para los botones de generar reporte
                document.querySelectorAll('.generate-report').forEach(button => {
                    button.addEventListener('click', function() {
                        const eventId = this.dataset.id;
                        const event = events.find(e => e.id === eventId);
                        if (event) {
                            generateReport(event);
                        }
                    });
                });
            }

            function renderSummary(events) {
                if (events.length === 0) {
                    riskLight.classList.remove('risk-low', 'risk-medium', 'risk-high', 'pulse');
                    riskText.textContent = 'Sin datos';
                    executiveSummary.textContent = 'Esperando datos para generar un resumen ejecutivo...';
                    return;
                }

                // Calcular el riesgo más alto
                const riskLevels = { 'low': 0, 'medium': 1, 'high': 2 };
                let highestRisk = 'low';
                
                events.forEach(event => {
                    if (riskLevels[event.public_health_risk] > riskLevels[highestRisk]) {
                        highestRisk = event.public_health_risk;
                    }
                });
                
                riskLight.classList.remove('risk-low', 'risk-medium', 'risk-high', 'pulse');
                riskLight.classList.add(`risk-${highestRisk}`);
                
                // Hacer parpadear el semáforo si el riesgo es alto
                if (highestRisk === 'high') {
                    riskLight.classList.add('pulse');
                }
                
                riskText.textContent = highestRisk === 'high' ? 'Alto' : highestRisk === 'medium' ? 'Medio' : 'Bajo';
                
                const summaryText = {
                    low: "La situación está controlada. El impacto es menor y los servicios operan con normalidad. Se mantiene monitoreo preventivo.",
                    medium: "Impacto moderado en infraestructura y servicios. Existen riesgos sanitarios localizados. Se recomienda a la población mantenerse informada y seguir indicaciones.",
                    high: "Situación crítica con impacto severo. Hay evacuaciones activas y riesgos significativos para la salud pública. Se requiere máxima precaución y atención a las directivas de las autoridades."
                };
                executiveSummary.textContent = summaryText[highestRisk];
            }
            
            function renderTicker(events) {
                const verifiedEvents = events.filter(e => e.verification === 'verified' || e.source_type === 'official').slice(0, 5);
                if (verifiedEvents.length === 0) {
                    tickerList.innerHTML = '<p class="text-gray-500 text-center py-4">No hay novedades verificadas recientemente.</p>';
                    return;
                }
                
                tickerList.innerHTML = verifiedEvents.map(event => `
                    <div class="fade-in">
                        <p class="font-semibold truncate">${event.headline}</p>
                        <p class="text-xs text-gray-500">${event.source_name} - ${formatTime(event.timestamp)}</p>
                    </div>
                `).join('<hr class="my-2">');
            }

            function renderAlerts(events) {
                const criticalAlerts = events.filter(e => e.change_flag);
                alertCount.textContent = criticalAlerts.length;
                
                if (criticalAlerts.length === 0) {
                    modalBody.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p>No hay alertas críticas en este momento.</p>
                        </div>
                    `;
                    return;
                }
                
                modalBody.innerHTML = criticalAlerts.map(alert => `
                    <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded fade-in">
                        <p class="font-bold">${alert.headline}</p>
                        <p class="text-sm mt-1">${alert.summary_120w}</p>
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-xs text-gray-500">Registrado a las ${formatTime(alert.timestamp)}</p>
                            ${alert.area ? `<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">${alert.area}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            // Generar reporte en formato DOC
            function generateDocReport(event) {
                const reportContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                          xmlns:w='urn:schemas-microsoft-com:office:word' 
                          xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset="UTF-8">
                        <title>Reporte de Vigilancia Basada en Eventos (VBE)</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 0 auto; padding: 20px; max-width: 800px; }
                            h1 { color: #003366; font-size: 1.5rem; margin-bottom: 0; text-align: center; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .date { font-size: 0.8rem; color: #6b7280; }
                            hr { border: none; border-top: 1px solid #e5e7eb; margin: 20px 0; }
                            h2 { font-size: 1.2rem; font-weight: bold; color: #1f2937; }
                            h3 { font-size: 1.1rem; font-weight: bold; color: #1f2937; margin-top: 20px; }
                            p { font-size: 1rem; color: #374151; margin-top: 5px; }
                            .footer { margin-top: 30px; font-size: 0.8rem; color: #9ca3af; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Reporte de Vigilancia Basada en Eventos (VBE)</h1>
                            <p class="date">Hermosillo, Sonora a ${new Date(event.timestamp).toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        </div>
                        <hr>
                        <h2>Notificación: ${event.headline}</h2>
                        <p><strong>Área que emite:</strong> Monitoreo Estatal</p>
                        <h3>Antecedentes</h3>
                        <p>${event.antecedentes || "Información no disponible"}</p>
                        <h3>Descripción de la situación actual</h3>
                        <p>${event.situacion_actual || "Información no disponible"}</p>
                        <h3>Acciones realizadas</h3>
                        <p>${event.acciones_realizadas || "Información no disponible"}</p>
                        <h3>Acciones por realizar</h3>
                        <p>${event.acciones_por_realizar || "Información no disponible"}</p>
                        <div class="footer">
                            <p>Fuente: <a href="${event.source_url}">${event.source_name}</a></p>
                            <p>Generado el: ${new Date().toLocaleDateString('es-MX')}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                return reportContent;
            }
            
            // Generar reporte en formato PDF
            function generatePdfReport(event) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let y = 15;
                
                // Título
                doc.setFontSize(16);
                doc.setTextColor(0, 51, 102);
                doc.text("Reporte de Vigilancia Basada en Eventos (VBE)", 105, y, { align: 'center' });
                y += 10;
                
                // Fecha
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text(`Hermosillo, Sonora a ${new Date(event.timestamp).toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' })}`, 105, y, { align: 'center' });
                y += 10;
                
                // Línea separadora
                doc.setDrawColor(229, 231, 235);
                doc.line(20, y, 190, y);
                y += 10;
                
                // Notificación
                doc.setFontSize(14);
                doc.setTextColor(31, 41, 55);
                doc.text(`Notificación: ${event.headline}`, 20, y);
                y += 10;
                
                // Área que emite
                doc.setFontSize(12);
                doc.setTextColor(55, 65, 81);
                doc.text(`Área que emite: Monitoreo Estatal`, 20, y);
                y += 15;
                
                // Antecedentes
                doc.setFontSize(12);
                doc.setTextColor(31, 41, 55);
                doc.text("Antecedentes:", 20, y);
                y += 8;
                
                doc.setFontSize(11);
                const antecedentes = event.antecedentes || "Información no disponible";
                const splitAntecedentes = doc.splitTextToSize(antecedentes, 170);
                doc.text(splitAntecedentes, 20, y);
                y += (splitAntecedentes.length * 5) + 10;
                
                // Situación actual
                doc.setFontSize(12);
                doc.setTextColor(31, 41, 55);
                doc.text("Descripción de la situación actual:", 20, y);
                y += 8;
                
                doc.setFontSize(11);
                const situacion = event.situacion_actual || "Información no disponible";
                const splitSituacion = doc.splitTextToSize(situacion, 170);
                doc.text(splitSituacion, 20, y);
                y += (splitSituacion.length * 5) + 10;
                
                // Acciones realizadas
                doc.setFontSize(12);
                doc.setTextColor(31, 41, 55);
                doc.text("Acciones realizadas:", 20, y);
                y += 8;
                
                doc.setFontSize(11);
                const accionesRealizadas = event.acciones_realizadas || "Información no disponible";
                const splitAcciones = doc.splitTextToSize(accionesRealizadas, 170);
                doc.text(splitAcciones, 20, y);
                y += (splitAcciones.length * 5) + 10;
                
                // Acciones por realizar
                doc.setFontSize(12);
                doc.setTextColor(31, 41, 55);
                doc.text("Acciones por realizar:", 20, y);
                y += 8;
                
                doc.setFontSize(11);
                const accionesPendientes = event.acciones_por_realizar || "Información no disponible";
                const splitPendientes = doc.splitTextToSize(accionesPendientes, 170);
                doc.text(splitPendientes, 20, y);
                y += (splitPendientes.length * 5) + 15;
                
                // Fuente
                doc.setFontSize(10);
                doc.setTextColor(107, 114, 128);
                doc.text(`Fuente: ${event.source_name} (${event.source_url})`, 20, y);
                y += 5;
                
                doc.text(`Generado el: ${new Date().toLocaleDateString('es-MX')}`, 20, y);
                
                return doc;
            }
            
            function downloadFile(filename, content, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function generateReport(event) {
                // Generar reporte DOC
                const docContent = generateDocReport(event);
                const blob = new Blob([docContent], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                
                // Abrir en nueva pestaña para que el usuario decida si guardar
                window.open(url, '_blank');
            }

            // --- Event Listeners ---
            filterButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-button')) {
                    filterButtonsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    updateDashboard();
                }
            });

            alertButton.addEventListener('click', () => {
                updateDashboard().then(() => {
                    renderAlerts(eventData);
                    alertsModal.classList.remove('hidden');
                    alertsModal.classList.add('flex');
                });
            });
            
            modalClose.addEventListener('click', () => alertsModal.classList.add('hidden'));
            
            // Cerrar modal al hacer clic fuera del contenido
            alertsModal.addEventListener('click', (e) => {
                if (e.target === alertsModal) {
                    alertsModal.classList.add('hidden');
                }
            });
            
            exportDocBtn.addEventListener('click', () => {
                // Exportar todos los eventos en formato DOC
                const docContent = generateDocReport({
                    timestamp: new Date().toISOString(),
                    headline: "Reporte Completo de Emergencias en Sonora",
                    antecedentes: "Resumen de todas las emergencias reportadas en el estado de Sonora.",
                    situacion_actual: "Situación actual basada en los últimos reportes recibidos.",
                    acciones_realizadas: "Acciones realizadas por las autoridades correspondientes.",
                    acciones_por_realizar: "Acciones pendientes por implementar.",
                    source_name: "Sistema de Monitoreo de Emergencias de Sonora",
                    source_url: window.location.href
                });
                
                downloadFile('reporte_emergencias_sonora.doc', docContent, 'application/msword');
            });

            exportPdfBtn.addEventListener('click', () => {
                // Exportar todos los eventos en formato PDF
                const doc = generatePdfReport({
                    timestamp: new Date().toISOString(),
                    headline: "Reporte Completo de Emergencias en Sonora",
                    antecedentes: "Resumen de todas las emergencias reportadas en el estado de Sonora.",
                    situacion_actual: "Situación actual basada en los últimos reportes recibidos.",
                    acciones_realizadas: "Acciones realizadas por las autoridades correspondientes.",
                    acciones_por_realizar: "Acciones pendientes por implementar.",
                    source_name: "Sistema de Monitoreo de Emergencias de Sonora",
                    source_url: window.location.href
                });
                
                doc.save('reporte_emergencias_sonora.pdf');
            });

            // --- Actualización de datos ---
            let eventData = [];
            let currentFilter = 'all';
            
            async function updateDashboard() {
                try {
                    // Obtener datos actualizados
                    eventData = await fetchEmergencyData();
                    
                    // Actualizar la hora de última actualización
                    const now = new Date();
                    const options = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: TIMEZONE };
                    lastUpdateTime.textContent = now.toLocaleTimeString('es-MX', options);
                    
                    // Renderizar componentes
                    renderTimeline(eventData, currentFilter);
                    renderSummary(eventData);
                    renderTicker(eventData);
                    
                    // Actualizar mapa
                    addMarkersToMap(eventData);
                    
                    console.log("Datos actualizados correctamente");
                } catch (error) {
                    console.error("Error actualizando datos:", error);
                }
            }

            // --- Inicialización ---
            function init() {
                // Inicializar mapa
                initMap();
                
                // Cargar datos iniciales
                updateDashboard();
                
                // Configurar actualización automática cada 90 segundos
                setInterval(updateDashboard, 90000);
            }

            init();
        });
    </script>
</body>
</html>
