<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo de Emergencias en Sonora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .risk-light {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            transition: background-color 0.5s ease-in-out;
        }
        .risk-low { 
            background-color: #4ade80; 
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }
        .risk-medium { 
            background-color: #facc15; 
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.5);
        }
        .risk-high { 
            background-color: #f87171; 
            box-shadow: 0 0 10px rgba(248, 113, 113, 0.5);
        }
        .filter-button.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Estilos para el mapa */
        .map-container {
            position: relative;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            height: 300px;
        }
        .map-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #a5f3fc 0%, #0ea5e9 100%);
            opacity: 0.7;
        }
        .map-point {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }
        .map-point:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 20;
        }
        .map-point.risk-high {
            background-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.4);
        }
        .map-point.risk-medium {
            background-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.4);
        }
        .map-point.risk-low {
            background-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.4);
        }
        .map-tooltip {
            position: absolute;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            max-width: 160px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .map-tooltip.visible {
            opacity: 1;
        }
        
        /* Animaciones */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* Mejoras visuales */
        .source-link {
            color: #3b82f6;
            text-decoration: underline;
        }
        .source-link:hover {
            color: #2563eb;
        }
        .export-button {
            transition: all 0.3s ease;
        }
        .export-button:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-600">Panel de Monitoreo de Emergencias</h1>
            <p class="text-lg text-gray-600 mt-2">Situación Actual en Sonora, México</p>
            <p class="text-sm text-gray-500 mt-1">Última actualización: <span id="last-update-time">--:--:--</span></p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Columna Principal (Izquierda) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Sección de Resumen y Riesgo -->
                <section class="card p-6">
                    <h2 class="text-2xl font-bold border-b-2 border-gray-100 pb-3 mb-4">Situación General</h2>
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <!-- Semáforo de Riesgo -->
                        <div class="text-center w-full md:w-1/4">
                             <h3 class="font-semibold text-gray-700 mb-2">Riesgo en Salud Pública</h3>
                             <div id="risk-light" class="risk-light risk-high mx-auto shadow-inner pulse"></div>
                             <p id="risk-text" class="font-bold text-lg mt-2 capitalize">Alto</p>
                        </div>
                        <!-- Resumen Ejecutivo -->
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-700 mb-2">Resumen Ejecutivo</h3>
                            <p id="executive-summary" class="text-gray-600">Situación crítica con impacto severo. Hay evacuaciones activas y riesgos significativos para la salud pública. Se requiere máxima precaución y atención a las directivas de las autoridades.</p>
                        </div>
                    </div>
                     <div class="mt-6 text-right">
                        <button id="alert-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                            Ver Alertas Críticas (<span id="alert-count">3</span>)
                        </button>
                    </div>
                </section>

                <!-- Cronología de Eventos -->
                <section class="card p-6">
                    <div class="flex flex-wrap justify-between items-center border-b-2 border-gray-100 pb-3 mb-4">
                         <h2 class="text-2xl font-bold">Cronología de Eventos</h2>
                         <div id="filter-buttons" class="flex flex-wrap gap-2 mt-2 md:mt-0">
                            <button class="filter-button active px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="all">Todos</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="official">Oficial</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="healthcare">Salud</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="infrastructure">Infraestructura</button>
                         </div>
                    </div>
                    <div id="timeline-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        <!-- Los eventos se insertarán aquí dinámicamente -->
                    </div>
                </section>
            </div>

            <!-- Columna Secundaria (Derecha) -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Ticker de Novedades -->
                <section class="card p-6">
                     <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Últimas Novedades Verificadas</h2>
                     <div id="ticker-list" class="space-y-3 max-h-48 overflow-y-auto pr-2 text-sm">
                        <!-- El ticker se llenará aquí -->
                     </div>
                </section>

                <!-- Mapa de Impacto -->
                <section class="card p-6">
                    <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Mapa de Impacto</h2>
                    <div class="map-container rounded-lg">
                        <div class="map-background"></div>
                        <!-- Los puntos del mapa se generarán dinámicamente -->
                        <div id="map-points-container"></div>
                        <div id="map-tooltip" class="map-tooltip"></div>
                        <div class="absolute bottom-4 left-4 bg-white p-2 rounded-lg shadow-md">
                            <div class="flex items-center mb-1">
                                <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                                <span class="text-xs">Alto riesgo</span>
                            </div>
                            <div class="flex items-center mb-1">
                                <div class="w-3 h-3 rounded-full bg-yellow-500 mr-2"></div>
                                <span class="text-xs">Medio riesgo</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                                <span class="text-xs">Bajo riesgo</span>
                            </div>
                        </div>
                    </div>
                </section>

                 <!-- Exportar Datos -->
                 <section class="card p-6">
                    <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Exportar Datos</h2>
                    <p class="text-sm text-gray-600 mb-4">Descargue el registro completo de eventos para su análisis.</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="export-json" class="export-button bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-sm">JSON</button>
                        <button id="export-csv" class="export-button bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-sm">CSV</button>
                        <button id="export-txt" class="export-button bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-sm">TXT</button>
                        <button id="export-pdf" class="export-button bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-sm">PDF</button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal para Alertas -->
    <div id="alerts-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="card p-6 rounded-lg max-w-lg w-full max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-2xl font-bold text-red-600">Alertas Críticas</h2>
                <button id="modal-close" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="overflow-y-auto max-h-[calc(90vh-8rem)] space-y-4">
                <!-- Contenido de las alertas se inserta aquí -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const TIMEZONE = 'America/Hermosillo';

            // --- Mock Data con enlaces a fuentes ---
            const eventData = [
                {
                    "id": "evt001", 
                    "timestamp_local": "2025-09-03T02:00:00-07:00", 
                    "source_type": "official", 
                    "source_name": "SMN/CONAGUA", 
                    "source_url": "https://smn.conagua.gob.mx/es/",
                    "topic": "rain",
                    "headline": "Lluvias intensas registran acumulado de 83 mm en Hermosillo", 
                    "summary_120w": "El Servicio Meteorológico Nacional reporta lluvias torrenciales durante la madrugada, con un acumulado de 83 milímetros en la zona norte de Hermosillo, superando los pronósticos iniciales.",
                    "verification": "verified", 
                    "public_health_risk": "medium", 
                    "change_flag": false,
                    "location": { "x": 25, "y": 40, "area": "Hermosillo Norte" }
                },
                {
                    "id": "evt002", 
                    "timestamp_local": "2025-09-03T04:30:00-07:00", 
                    "source_type": "media", 
                    "source_name": "El Imparcial", 
                    "source_url": "https://www.elimparcial.com/",
                    "topic": "infrastructure",
                    "headline": "Inundaciones severas en colonias Mirasoles, Bachoco y La Caridad", 
                    "summary_120w": "Medios locales informan de inundaciones significativas y arrastre de vehículos en varias colonias del norte de la ciudad. Se reportan cortes de energía y caída de árboles.",
                    "verification": "verified", 
                    "public_health_risk": "medium", 
                    "change_flag": false,
                    "location": { "x": 30, "y": 50, "area": "Mirasoles" }
                },
                {
                    "id": "evt003", 
                    "timestamp_local": "2025-09-03T07:00:00-07:00", 
                    "source_type": "official", 
                    "source_name": "Ayuntamiento de Hermosillo", 
                    "source_url": "https://www.hermosillo.gob.mx/",
                    "topic": "evacuation",
                    "headline": "Evalúan evacuación de 40 familias en la colonia La Caridad", 
                    "summary_120w": "Autoridades municipales informan que 40 viviendas en La Caridad sufrieron daños por inundación. Se está analizando el traslado de los afectados a refugios temporales.",
                    "verification": "verified", 
                    "public_health_risk": "high", 
                    "change_flag": true,
                    "location": { "x": 35, "y": 60, "area": "La Caridad" }
                },
                {
                    "id": "evt004", 
                    "timestamp_local": "2025-09-03T08:15:00-07:00", 
                    "source_type": "official", 
                    "source_name": "Protección Civil Sonora", 
                    "source_url": "https://proteccioncivil.sonora.gob.mx/",
                    "topic": "shelters",
                    "headline": "Habilitan 5 refugios temporales en Hermosillo", 
                    "summary_120w": "Se habilitan oficialmente los Centros Hábitat, Solidaridad 1, Minitas, Casa Galilea y Miguel Alemán como refugios temporales para recibir a las familias afectadas por las inundaciones.",
                    "verification": "verified", 
                    "public_health_risk": "high", 
                    "change_flag": true,
                    "location": { "x": 40, "y": 70, "area": "Centro" }
                },
                {
                    "id": "evt005", 
                    "timestamp_local": "2025-09-03T09:00:00-07:00", 
                    "source_type": "official", 
                    "source_name": "Secretaría de Salud Sonora", 
                    "source_url": "https://www.saludsonora.gob.mx/",
                    "topic": "healthcare",
                    "headline": "Emiten alerta sanitaria por riesgos tras inundaciones", 
                    "summary_120w": "La Secretaría de Salud emite recomendaciones para prevenir enfermedades diarreicas y transmitidas por vector (dengue). Se pide a la población clorar el agua, manejar adecuadamente los residuos y evitar el contacto con aguas estancadas.",
                    "verification": "verified", 
                    "public_health_risk": "high", 
                    "change_flag": true,
                    "location": { "x": 45, "y": 80, "area": "Hermosillo Sur" }
                }
            ].sort((a, b) => new Date(b.timestamp_local) - new Date(a.timestamp_local));

            // --- Elementos del DOM ---
            const lastUpdateTime = document.getElementById('last-update-time');
            const riskLight = document.getElementById('risk-light');
            const riskText = document.getElementById('risk-text');
            const executiveSummary = document.getElementById('executive-summary');
            const timelineContainer = document.getElementById('timeline-container');
            const filterButtonsContainer = document.getElementById('filter-buttons');
            const tickerList = document.getElementById('ticker-list');
            const alertButton = document.getElementById('alert-button');
            const alertCount = document.getElementById('alert-count');
            const alertsModal = document.getElementById('alerts-modal');
            const modalClose = document.getElementById('modal-close');
            const modalBody = document.getElementById('modal-body');
            const exportJsonBtn = document.getElementById('export-json');
            const exportCsvBtn = document.getElementById('export-csv');
            const exportTxtBtn = document.getElementById('export-txt');
            const exportPdfBtn = document.getElementById('export-pdf');
            const mapPointsContainer = document.getElementById('map-points-container');
            const mapTooltip = document.getElementById('map-tooltip');

            // --- Funciones de Renderizado ---
            function formatTime(isoString) {
                const options = { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: TIMEZONE };
                return new Date(isoString).toLocaleTimeString('es-MX', options);
            }

            function renderTimeline(filter = 'all') {
                let filteredData = eventData;
                if (filter !== 'all') {
                    filteredData = eventData.filter(event => event.source_type === filter || event.topic === filter);
                }

                if (filteredData.length === 0) {
                    timelineContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay eventos para este filtro.</p>`;
                    return;
                }

                timelineContainer.innerHTML = filteredData.map(event => `
                    <div class="flex gap-4 timeline-event">
                        <div class="text-right w-20 flex-shrink-0">
                            <p class="font-bold text-sm text-blue-600">${formatTime(event.timestamp_local)}</p>
                            <p class="text-xs text-gray-500">${new Date(event.timestamp_local).toLocaleDateString('es-MX', { day: '2-digit', month: 'short' })}</p>
                        </div>
                        <div class="relative w-full">
                            <div class="absolute top-1 left-[-22px] w-4 h-4 rounded-full bg-white border-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'}"></div>
                            <div class="border-l-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'} pl-6 pb-4">
                                <p class="font-semibold">${event.headline}</p>
                                <p class="text-sm text-gray-600 mt-1">${event.summary_120w}</p>
                                <p class="text-xs text-gray-500 mt-2">Fuente: 
                                    <a href="${event.source_url}" target="_blank" class="source-link">${event.source_name}</a> 
                                    <span class="uppercase font-bold">${event.source_type}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function renderSummary() {
                const latestRisk = eventData[0]?.public_health_risk || 'low';
                
                riskLight.classList.remove('risk-low', 'risk-medium', 'risk-high', 'pulse');
                riskLight.classList.add(`risk-${latestRisk}`);
                
                // Hacer parpadear el semáforo si el riesgo es alto
                if (latestRisk === 'high') {
                    riskLight.classList.add('pulse');
                }
                
                riskText.textContent = latestRisk === 'high' ? 'Alto' : latestRisk === 'medium' ? 'Medio' : 'Bajo';
                
                const summaryText = {
                    low: "La situación está controlada. El impacto es menor y los servicios operan con normalidad. Se mantiene monitoreo preventivo.",
                    medium: "Impacto moderado en infraestructura y servicios. Existen riesgos sanitarios localizados. Se recomienda a la población mantenerse informada y seguir indicaciones.",
                    high: "Situación crítica con impacto severo. Hay evacuaciones activas y riesgos significativos para la salud pública. Se requiere máxima precaución y atención a las directivas de las autoridades."
                };
                executiveSummary.textContent = summaryText[latestRisk];
            }
            
            function renderTicker() {
                const verifiedEvents = eventData.filter(e => e.verification === 'verified').slice(0, 5);
                if (verifiedEvents.length === 0) {
                    tickerList.innerHTML = '<p class="text-gray-500 text-center py-4">No hay novedades verificadas recientemente.</p>';
                    return;
                }
                
                tickerList.innerHTML = verifiedEvents.map(event => `
                    <div class="fade-in">
                        <p class="font-semibold truncate">${event.headline}</p>
                        <p class="text-xs text-gray-500">${event.source_name} - ${formatTime(event.timestamp_local)}</p>
                    </div>
                `).join('<hr class="my-2">');
            }

            function renderAlerts() {
                const criticalAlerts = eventData.filter(e => e.change_flag);
                alertCount.textContent = criticalAlerts.length;
                
                if (criticalAlerts.length === 0) {
                    modalBody.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p>No hay alertas críticas en este momento.</p>
                        </div>
                    `;
                    return;
                }
                
                modalBody.innerHTML = criticalAlerts.map(alert => `
                    <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded fade-in">
                        <p class="font-bold">${alert.headline}</p>
                        <p class="text-sm mt-1">${alert.summary_120w}</p>
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-xs text-gray-500">Registrado a las ${formatTime(alert.timestamp_local)}</p>
                            ${alert.location ? `<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">${alert.location.area}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            }

            function renderMap() {
                // Limpiar contenedor de puntos
                mapPointsContainer.innerHTML = '';
                
                // Crear puntos para eventos con ubicación
                eventData.filter(event => event.location).forEach(event => {
                    const point = document.createElement('div');
                    point.className = `map-point risk-${event.public_health_risk}`;
                    point.style.left = `${event.location.x}%`;
                    point.style.top = `${event.location.y}%`;
                    point.dataset.area = event.location.area;
                    point.dataset.headline = event.headline;
                    point.dataset.risk = event.public_health_risk;
                    
                    // Eventos para mostrar tooltip
                    point.addEventListener('mouseenter', function(e) {
                        const rect = this.getBoundingClientRect();
                        mapTooltip.textContent = `${event.location.area}: ${event.headline}`;
                        mapTooltip.style.left = `${rect.left + window.scrollX}px`;
                        mapTooltip.style.top = `${rect.top + window.scrollY - 40}px`;
                        mapTooltip.classList.add('visible');
                    });
                    
                    point.addEventListener('mouseleave', function() {
                        mapTooltip.classList.remove('visible');
                    });
                    
                    point.addEventListener('click', function() {
                        // Filtrar eventos por área al hacer clic
                        currentFilter = 'all';
                        document.querySelectorAll('.filter-button').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.filter === 'all');
                        });
                        
                        // Buscar eventos en esta área
                        const areaEvents = eventData.filter(e => e.location && e.location.area === event.location.area);
                        if (areaEvents.length > 0) {
                            const filteredData = areaEvents;
                            renderCustomTimeline(filteredData, `Eventos en ${event.location.area}`);
                        }
                    });
                    
                    mapPointsContainer.appendChild(point);
                });
            }

            function renderCustomTimeline(events, title) {
                if (events.length === 0) {
                    timelineContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay eventos para este filtro.</p>`;
                    return;
                }

                timelineContainer.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">${title}</h3>
                        <button id="reset-filter" class="text-sm text-blue-500 hover:text-blue-700">Ver todos los eventos</button>
                    </div>
                    ${events.map(event => `
                        <div class="flex gap-4 timeline-event">
                            <div class="text-right w-20 flex-shrink-0">
                                <p class="font-bold text-sm text-blue-600">${formatTime(event.timestamp_local)}</p>
                                <p class="text-xs text-gray-500">${new Date(event.timestamp_local).toLocaleDateString('es-MX', { day: '2-digit', month: 'short' })}</p>
                            </div>
                            <div class="relative w-full">
                                <div class="absolute top-1 left-[-22px] w-4 h-4 rounded-full bg-white border-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'}"></div>
                                <div class="border-l-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'} pl-6 pb-4">
                                    <p class="font-semibold">${event.headline}</p>
                                    <p class="text-sm text-gray-600 mt-1">${event.summary_120w}</p>
                                    <p class="text-xs text-gray-500 mt-2">Fuente: 
                                        <a href="${event.source_url}" target="_blank" class="source-link">${event.source_name}</a> 
                                        <span class="uppercase font-bold">${event.source_type}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                `;

                // Añadir event listener al botón de reset
                document.getElementById('reset-filter').addEventListener('click', () => {
                    renderTimeline('all');
                    filterButtonsContainer.querySelector('.active').classList.remove('active');
                    filterButtonsContainer.querySelector('[data-filter="all"]').classList.add('active');
                });
            }

            // --- Funciones de Exportación ---
            function downloadFile(filename, content, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function exportToJSON() {
                const jsonData = JSON.stringify(eventData, null, 2);
                downloadFile('monitoreo_eventos.json', jsonData, 'application/json');
            }

            function exportToCSV() {
                const headers = "id,timestamp_local,source_type,source_name,source_url,topic,headline,summary_120w,verification,public_health_risk,change_flag";
                const rows = eventData.map(e => `"${e.id}","${e.timestamp_local}","${e.source_type}","${e.source_name}","${e.source_url}","${e.topic}","${e.headline.replace(/"/g, '""')}","${e.summary_120w.replace(/"/g, '""')}","${e.verification}","${e.public_health_risk}",${e.change_flag}`);
                const csvData = `${headers}\n${rows.join('\n')}`;
                downloadFile('monitoreo_eventos.csv', csvData, 'text/csv;charset=utf-8;');
            }

            function exportToTXT() {
                let txtData = "PANEL DE MONITOREO DE EMERGENCIAS - SONORA\n";
                txtData += "============================================\n\n";
                
                eventData.forEach(event => {
                    txtData += `EVENTO: ${event.headline}\n`;
                    txtData += `FECHA: ${new Date(event.timestamp_local).toLocaleDateString('es-MX')}\n`;
                    txtData += `HORA: ${formatTime(event.timestamp_local)}\n`;
                    txtData += `FUENTE: ${event.source_name} (${event.source_type})\n`;
                    txtData += `ENLACE: ${event.source_url}\n`;
                    txtData += `DESCRIPCIÓN: ${event.summary_120w}\n`;
                    txtData += `RIESGO: ${event.public_health_risk}\n`;
                    txtData += `ALERTA: ${event.change_flag ? 'CRÍTICA' : 'Normal'}\n`;
                    txtData += "----------------------------------------\n\n";
                });
                
                downloadFile('monitoreo_eventos.txt', txtData, 'text/plain');
            }

            function exportToPDF() {
                // Usar jsPDF para generar PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Título
                doc.setFontSize(20);
                doc.text("PANEL DE MONITOREO DE EMERGENCIAS - SONORA", 105, 15, { align: 'center' });
                
                // Fecha de exportación
                doc.setFontSize(12);
                doc.text(`Exportado el: ${new Date().toLocaleDateString('es-MX')}`, 105, 22, { align: 'center' });
                
                // Contenido
                let y = 35;
                eventData.forEach((event, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.text(`${index + 1}. ${event.headline}`, 14, y);
                    y += 8;
                    
                    doc.setFontSize(10);
                    doc.text(`Fecha: ${new Date(event.timestamp_local).toLocaleDateString('es-MX')} ${formatTime(event.timestamp_local)}`, 14, y);
                    y += 5;
                    
                    doc.text(`Fuente: ${event.source_name} (${event.source_type})`, 14, y);
                    y += 5;
                    
                    doc.text(`Enlace: ${event.source_url}`, 14, y);
                    y += 5;
                    
                    // Descripción con texto ajustado
                    const splitText = doc.splitTextToSize(event.summary_120w, 180);
                    doc.text(splitText, 14, y);
                    y += (splitText.length * 5) + 5;
                    
                    doc.text(`Riesgo: ${event.public_health_risk}`, 14, y);
                    y += 5;
                    
                    doc.text(`Alerta: ${event.change_flag ? 'CRÍTICA' : 'Normal'}`, 14, y);
                    y += 10;
                });
                
                doc.save('monitoreo_eventos.pdf');
            }

            // --- Event Listeners ---
            filterButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-button')) {
                    filterButtonsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    renderTimeline(e.target.dataset.filter);
                }
            });

            alertButton.addEventListener('click', () => {
                renderAlerts();
                alertsModal.classList.remove('hidden');
                alertsModal.classList.add('flex');
            });
            
            modalClose.addEventListener('click', () => alertsModal.classList.add('hidden'));
            
            // Cerrar modal al hacer clic fuera del contenido
            alertsModal.addEventListener('click', (e) => {
                if (e.target === alertsModal) {
                    alertsModal.classList.add('hidden');
                }
            });
            
            // Exportación de datos
            exportJsonBtn.addEventListener('click', exportToJSON);
            exportCsvBtn.addEventListener('click', exportToCSV);
            exportTxtBtn.addEventListener('click', exportToTXT);
            exportPdfBtn.addEventListener('click', exportToPDF);

            // --- Inicialización ---
            function init() {
                const now = new Date();
                const options = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: TIMEZONE };
                lastUpdateTime.textContent = now.toLocaleTimeString('es-MX', options);
                
                renderTimeline();
                renderSummary();
                renderTicker();
                renderAlerts();
                renderMap();
            }

            init();
        });
    </script>
</body>
</html>
