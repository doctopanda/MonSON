<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo de Emergencias en Sonora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .risk-light {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            transition: background-color 0.5s ease-in-out;
        }
        .risk-low { 
            background-color: #4ade80; 
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }
        .risk-medium { 
            background-color: #facc15; 
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.5);
        }
        .risk-high { 
            background-color: #f87171; 
            box-shadow: 0 0 10px rgba(248, 113, 113, 0.5);
        }
        .filter-button.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Estilos para el mapa */
        .map-container {
            position: relative;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            height: 300px;
        }
        .map-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #a5f3fc 0%, #0ea5e9 100%);
            opacity: 0.7;
        }
        .map-point {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }
        .map-point:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 20;
        }
        .map-point.risk-high {
            background-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.4);
        }
        .map-point.risk-medium {
            background-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.4);
        }
        .map-point.risk-low {
            background-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.4);
        }
        .map-tooltip {
            position: absolute;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            max-width: 160px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .map-tooltip.visible {
            opacity: 1;
        }
        
        /* Animaciones */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* Mejoras visuales */
        .source-link {
            color: #3b82f6;
            text-decoration: underline;
        }
        .source-link:hover {
            color: #2563eb;
        }
        .export-button {
            transition: all 0.3s ease;
        }
        .export-button:hover {
            transform: translateY(-2px);
        }
        .social-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 6px;
        }
        .facebook { background-color: #1877f2; color: white; }
        .twitter { background-color: #1da1f2; color: white; }
        .instagram { background-color: #e4405f; color: white; }
        .tiktok { background-color: #000000; color: white; }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-600">Panel de Monitoreo de Emergencias</h1>
            <p class="text-lg text-gray-600 mt-2">Situación Actual en Sonora, México</p>
            <p class="text-sm text-gray-500 mt-1">Última actualización: <span id="last-update-time">--:--:--</span></p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Columna Principal (Izquierda) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Sección de Resumen y Riesgo -->
                <section class="card p-6">
                    <h2 class="text-2xl font-bold border-b-2 border-gray-100 pb-3 mb-4">Situación General</h2>
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <!-- Semáforo de Riesgo -->
                        <div class="text-center w-full md:w-1/4">
                             <h3 class="font-semibold text-gray-700 mb-2">Riesgo en Salud Pública</h3>
                             <div id="risk-light" class="risk-light risk-high mx-auto shadow-inner pulse"></div>
                             <p id="risk-text" class="font-bold text-lg mt-2 capitalize">Alto</p>
                        </div>
                        <!-- Resumen Ejecutivo -->
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-700 mb-2">Resumen Ejecutivo</h3>
                            <p id="executive-summary" class="text-gray-600">Situación crítica con impacto severo. Hay evacuaciones activas y riesgos significativos para la salud pública. Se requiere máxima precaución y atención a las directivas de las autoridades.</p>
                        </div>
                    </div>
                     <div class="mt-6 text-right">
                        <button id="alert-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                            Ver Alertas Críticas (<span id="alert-count">3</span>)
                        </button>
                    </div>
                </section>

                <!-- Cronología de Eventos -->
                <section class="card p-6">
                    <div class="flex flex-wrap justify-between items-center border-b-2 border-gray-100 pb-3 mb-4">
                         <h2 class="text-2xl font-bold">Cronología de Eventos</h2>
                         <div id="filter-buttons" class="flex flex-wrap gap-2 mt-2 md:mt-0">
                            <button class="filter-button active px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="all">Todos</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="official">Oficial</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="healthcare">Salud</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="infrastructure">Infraestructura</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="social">Redes Sociales</button>
                         </div>
                    </div>
                    <div id="timeline-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        <!-- Los eventos se insertarán aquí dinámicamente -->
                    </div>
                </section>
            </div>

            <!-- Columna Secundaria (Derecha) -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Ticker de Novedades -->
                <section class="card p-6">
                     <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Últimas Novedades Verificadas</h2>
                     <div id="ticker-list" class="space-y-3 max-h-48 overflow-y-auto pr-2 text-sm">
                        <!-- El ticker se llenará aquí -->
                     </div>
                </section>

                <!-- Mapa de Impacto -->
                <section class="card p-6">
                    <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Mapa de Impacto</h2>
                    <div class="map-container rounded-lg">
                        <div class="map-background"></div>
                        <!-- Los puntos del mapa se generarán dinámicamente -->
                        <div id="map-points-container"></div>
                        <div id="map-tooltip" class="map-tooltip"></div>
                        <div class="absolute bottom-4 left-4 bg-white p-2 rounded-lg shadow-md">
                            <div class="flex items-center mb-1">
                                <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                                <span class="text-xs">Alto riesgo</span>
                            </div>
                            <div class="flex items-center mb-1">
                                <div class="w-3 h-3 rounded-full bg-yellow-500 mr-2"></div>
                                <span class="text-xs">Medio riesgo</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                                <span class="text-xs">Bajo riesgo</span>
                            </div>
                        </div>
                    </div>
                </section>

                 <!-- Exportar Datos -->
                 <section class="card p-6">
                    <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Exportar Datos</h2>
                    <p class="text-sm text-gray-600 mb-4">Descargue el registro completo de eventos para su análisis.</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="export-txt" class="export-button bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-sm">TXT</button>
                        <button id="export-pdf" class="export-button bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-sm">PDF</button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal para Alertas -->
    <div id="alerts-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="card p-6 rounded-lg max-w-lg w-full max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-2xl font-bold text-red-600">Alertas Críticas</h2>
                <button id="modal-close" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="overflow-y-auto max-h-[calc(90vh-8rem)] space-y-4">
                <!-- Contenido de las alertas se inserta aquí -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const TIMEZONE = 'America/Hermosillo';

            // --- Datos de ejemplo con enlaces específicos y redes sociales ---
            const eventData = [
                {
                    "id": "evt001", 
                    "timestamp_local": "2025-09-03T02:00:00-07:00", 
                    "source_type": "official", 
                    "source_name": "SMN/CONAGUA", 
                    "source_url": "https://smn.conagua.gob.mx/es/comunicados/lluvias-intensas-hermosillo-septiembre-2025",
                    "topic": "rain",
                    "headline": "Lluvias intensas registran acumulado de 83 mm en Hermosillo", 
                    "summary_120w": "El Servicio Meteorológico Nacional reporta lluvias torrenciales durante la madrugada, con un acumulado de 83 milímetros en la zona norte de Hermosillo, superando los pronósticos iniciales.",
                    "verification": "verified", 
                    "public_health_risk": "medium", 
                    "change_flag": false,
                    "location": { "x": 25, "y": 40, "area": "Hermosillo Norte" },
                    "antecedentes": "Las lluvias registradas la madrugada de este miércoles en la capital de Sonora, dejaron un acumulado de hasta 83 milímetros, provocando afectaciones principalmente en la zona norte de la ciudad.",
                    "situacion_actual": "Lluvias intensas continúan afectando la zona norte de Hermosillo.",
                    "acciones_realizadas": "Monitoreo constante por parte del SMN/CONAGUA.",
                    "acciones_pendientes": "Seguimiento de la evolución meteorológica."
                },
                {
                    "id": "evt002", 
                    "timestamp_local": "2025-09-03T04:30:00-07:00", 
                    "source_type": "media", 
                    "source_name": "El Imparcial", 
                    "source_url": "https://www.elimparcial.com/hermosillo/inundaciones-severas-colonias-mirasoles-bachoco-caridad",
                    "topic": "infrastructure",
                    "headline": "Inundaciones severas en colonias Mirasoles, Bachoco y La Caridad", 
                    "summary_120w": "Medios locales informan de inundaciones significativas y arrastre de vehículos en varias colonias del norte de la ciudad. Se reportan cortes de energía y caída de árboles.",
                    "verification": "verified", 
                    "public_health_risk": "medium", 
                    "change_flag": false,
                    "location": { "x": 30, "y": 50, "area": "Mirasoles" },
                    "antecedentes": "Durante la tormenta se atendieron reportes de inundaciones en colonias como Mirasoles, Bachoco y Caridad, además de caídas de árboles, acumulación de agua en calles y el arrastre de vehículos en cauces pluviales.",
                    "situacion_actual": "Inundaciones severas en colonias del norte de Hermosillo.",
                    "acciones_realizadas": "Equipos de emergencia desplegados en la zona.",
                    "acciones_pendientes": "Evaluación de daños y necesidades de la población afectada."
                },
                {
                    "id": "evt003", 
                    "timestamp_local": "2025-09-03T07:00:00-07:00", 
                    "source_type": "official", 
                    "source_name": "Ayuntamiento de Hermosillo", 
                    "source_url": "https://www.hermosillo.gob.mx/noticias/evacuacion-familias-la-caridad",
                    "topic": "evacuation",
                    "headline": "Evalúan evacuación de 40 familias en la colonia La Caridad", 
                    "summary_120w": "Autoridades municipales informan que 40 viviendas en La Caridad sufrieron daños por inundación. Se está analizando el traslado de los afectados a refugios temporales.",
                    "verification": "verified", 
                    "public_health_risk": "high", 
                    "change_flag": true,
                    "location": { "x": 35, "y": 60, "area": "La Caridad" },
                    "antecedentes": "Las lluvias registradas la madrugada de este miércoles provocaron afectaciones materiales en viviendas de la colonia La Caridad.",
                    "situacion_actual": "40 familias afectadas con daños en sus viviendas. Se analiza su traslado a refugios temporales.",
                    "acciones_realizadas": "Evaluación de daños en viviendas.",
                    "acciones_pendientes": "Coordinación para habilitación de refugios temporales."
                },
                {
                    "id": "evt004", 
                    "timestamp_local": "2025-09-03T08:15:00-07:00", 
                    "source_type": "official", 
                    "source_name": "Protección Civil Sonora", 
                    "source_url": "https://proteccioncivil.sonora.gob.mx/refugios-temporales-hermosillo",
                    "topic": "shelters",
                    "headline": "Habilitan 5 refugios temporales en Hermosillo", 
                    "summary_120w": "Se habilitan oficialmente los Centros Hábitat, Solidaridad 1, Minitas, Casa Galilea y Miguel Alemán como refugios temporales para recibir a las familias afectadas por las inundaciones.",
                    "verification": "verified", 
                    "public_health_risk": "high", 
                    "change_flag": true,
                    "location": { "x": 40, "y": 70, "area": "Centro" },
                    "antecedentes": "Ante las afectaciones por inundaciones en colonias del norte de Hermosillo.",
                    "situacion_actual": "5 refugios temporales habilitados para recibir a familias afectadas.",
                    "acciones_realizadas": "Habilitación de refugios temporales.",
                    "acciones_pendientes": "Coordinación interinstitucional para atención a afectados."
                },
                {
                    "id": "evt005", 
                    "timestamp_local": "2025-09-03T09:00:00-07:00", 
                    "source_type": "official", 
                    "source_name": "Secretaría de Salud Sonora", 
                    "source_url": "https://www.saludsonora.gob.mx/alerta-sanitaria-inundaciones",
                    "topic": "healthcare",
                    "headline": "Emiten alerta sanitaria por riesgos tras inundaciones", 
                    "summary_120w": "La Secretaría de Salud emite recomendaciones para prevenir enfermedades diarreicas y transmitidas por vector (dengue). Se pide a la población clorar el agua, manejar adecuadamente los residuos y evitar el contacto con aguas estancadas.",
                    "verification": "verified", 
                    "public_health_risk": "high", 
                    "change_flag": true,
                    "location": { "x": 45, "y": 80, "area": "Hermosillo Sur" },
                    "antecedentes": "Inundaciones recientes en Hermosillo.",
                    "situacion_actual": "Riesgo de enfermedades diarreicas y transmitidas por vector.",
                    "acciones_realizadas": "Emisión de alerta sanitaria.",
                    "acciones_pendientes": "Difusión de medidas preventivas a la población."
                },
                {
                    "id": "evt006", 
                    "timestamp_local": "2025-09-03T10:30:00-07:00", 
                    "source_type": "social", 
                    "source_name": "Facebook", 
                    "source_url": "https://www.facebook.com/photo.php?fbid=1265165928625665",
                    "social_platform": "facebook",
                    "topic": "evacuation",
                    "headline": "Vecinos reportan evacuación en La Caridad", 
                    "summary_120w": "Vecinos de la colonia La Caridad comparten en redes sociales imágenes de las afectaciones y el proceso de evacuación de familias.",
                    "verification": "pending", 
                    "public_health_risk": "medium", 
                    "change_flag": false,
                    "location": { "x": 35, "y": 62, "area": "La Caridad" }
                },
                {
                    "id": "evt007", 
                    "timestamp_local": "2025-09-03T11:15:00-07:00", 
                    "source_type": "social", 
                    "source_name": "Twitter", 
                    "source_url": "https://twitter.com/usuario/status/1234567890123456789",
                    "social_platform": "twitter",
                    "topic": "infrastructure",
                    "headline": "Usuario reporta corte de energía en Mirasoles", 
                    "summary_120w": "Usuario de Twitter reporta corte de energía eléctrica en la colonia Mirasoles desde las 10:45 AM.",
                    "verification": "pending", 
                    "public_health_risk": "low", 
                    "change_flag": false,
                    "location": { "x": 32, "y": 52, "area": "Mirasoles" }
                }
            ].sort((a, b) => new Date(b.timestamp_local) - new Date(a.timestamp_local));

            // --- Elementos del DOM ---
            const lastUpdateTime = document.getElementById('last-update-time');
            const riskLight = document.getElementById('risk-light');
            const riskText = document.getElementById('risk-text');
            const executiveSummary = document.getElementById('executive-summary');
            const timelineContainer = document.getElementById('timeline-container');
            const filterButtonsContainer = document.getElementById('filter-buttons');
            const tickerList = document.getElementById('ticker-list');
            const alertButton = document.getElementById('alert-button');
            const alertCount = document.getElementById('alert-count');
            const alertsModal = document.getElementById('alerts-modal');
            const modalClose = document.getElementById('modal-close');
            const modalBody = document.getElementById('modal-body');
            const exportTxtBtn = document.getElementById('export-txt');
            const exportPdfBtn = document.getElementById('export-pdf');
            const mapPointsContainer = document.getElementById('map-points-container');
            const mapTooltip = document.getElementById('map-tooltip');

            // --- Funciones de Renderizado ---
            function formatTime(isoString) {
                const options = { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: TIMEZONE };
                return new Date(isoString).toLocaleTimeString('es-MX', options);
            }

            function getSocialBadge(platform) {
                if (!platform) return '';
                return `<span class="social-badge ${platform}">${platform.toUpperCase()}</span>`;
            }

            function renderTimeline(filter = 'all') {
                let filteredData = eventData;
                if (filter !== 'all') {
                    if (filter === 'social') {
                        filteredData = eventData.filter(event => event.source_type === 'social');
                    } else {
                        filteredData = eventData.filter(event => event.source_type === filter || event.topic === filter);
                    }
                }

                if (filteredData.length === 0) {
                    timelineContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay eventos para este filtro.</p>`;
                    return;
                }

                timelineContainer.innerHTML = filteredData.map(event => `
                    <div class="flex gap-4 timeline-event">
                        <div class="text-right w-20 flex-shrink-0">
                            <p class="font-bold text-sm text-blue-600">${formatTime(event.timestamp_local)}</p>
                            <p class="text-xs text-gray-500">${new Date(event.timestamp_local).toLocaleDateString('es-MX', { day: '2-digit', month: 'short' })}</p>
                        </div>
                        <div class="relative w-full">
                            <div class="absolute top-1 left-[-22px] w-4 h-4 rounded-full bg-white border-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'}"></div>
                            <div class="border-l-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'} pl-6 pb-4">
                                <p class="font-semibold">${event.headline} ${event.social_platform ? getSocialBadge(event.social_platform) : ''}</p>
                                <p class="text-sm text-gray-600 mt-1">${event.summary_120w}</p>
                                <p class="text-xs text-gray-500 mt-2">Fuente: 
                                    <a href="${event.source_url}" target="_blank" class="source-link">${event.source_name}</a> 
                                    <span class="uppercase font-bold">${event.source_type}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function renderSummary() {
                const latestRisk = eventData[0]?.public_health_risk || 'low';
                
                riskLight.classList.remove('risk-low', 'risk-medium', 'risk-high', 'pulse');
                riskLight.classList.add(`risk-${latestRisk}`);
                
                // Hacer parpadear el semáforo si el riesgo es alto
                if (latestRisk === 'high') {
                    riskLight.classList.add('pulse');
                }
                
                riskText.textContent = latestRisk === 'high' ? 'Alto' : latestRisk === 'medium' ? 'Medio' : 'Bajo';
                
                const summaryText = {
                    low: "La situación está controlada. El impacto es menor y los servicios operan con normalidad. Se mantiene monitoreo preventivo.",
                    medium: "Impacto moderado en infraestructura y servicios. Existen riesgos sanitarios localizados. Se recomienda a la población mantenerse informada y seguir indicaciones.",
                    high: "Situación crítica con impacto severo. Hay evacuaciones activas y riesgos significativos para la salud pública. Se requiere máxima precaución y atención a las directivas de las autoridades."
                };
                executiveSummary.textContent = summaryText[latestRisk];
            }
            
            function renderTicker() {
                const verifiedEvents = eventData.filter(e => e.verification === 'verified').slice(0, 5);
                if (verifiedEvents.length === 0) {
                    tickerList.innerHTML = '<p class="text-gray-500 text-center py-4">No hay novedades verificadas recientemente.</p>';
                    return;
                }
                
                tickerList.innerHTML = verifiedEvents.map(event => `
                    <div class="fade-in">
                        <p class="font-semibold truncate">${event.headline}</p>
                        <p class="text-xs text-gray-500">${event.source_name} - ${formatTime(event.timestamp_local)}</p>
                    </div>
                `).join('<hr class="my-2">');
            }

            function renderAlerts() {
                const criticalAlerts = eventData.filter(e => e.change_flag);
                alertCount.textContent = criticalAlerts.length;
                
                if (criticalAlerts.length === 0) {
                    modalBody.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p>No hay alertas críticas en este momento.</p>
                        </div>
                    `;
                    return;
                }
                
                modalBody.innerHTML = criticalAlerts.map(alert => `
                    <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded fade-in">
                        <p class="font-bold">${alert.headline}</p>
                        <p class="text-sm mt-1">${alert.summary_120w}</p>
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-xs text-gray-500">Registrado a las ${formatTime(alert.timestamp_local)}</p>
                            ${alert.location ? `<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">${alert.location.area}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            }

            function renderMap() {
                // Limpiar contenedor de puntos
                mapPointsContainer.innerHTML = '';
                
                // Crear puntos para eventos con ubicación
                eventData.filter(event => event.location).forEach(event => {
                    const point = document.createElement('div');
                    point.className = `map-point risk-${event.public_health_risk}`;
                    point.style.left = `${event.location.x}%`;
                    point.style.top = `${event.location.y}%`;
                    point.dataset.area = event.location.area;
                    point.dataset.headline = event.headline;
                    point.dataset.risk = event.public_health_risk;
                    
                    // Eventos para mostrar tooltip
                    point.addEventListener('mouseenter', function(e) {
                        const rect = this.getBoundingClientRect();
                        mapTooltip.textContent = `${event.location.area}: ${event.headline}`;
                        mapTooltip.style.left = `${rect.left + window.scrollX}px`;
                        mapTooltip.style.top = `${rect.top + window.scrollY - 40}px`;
                        mapTooltip.classList.add('visible');
                    });
                    
                    point.addEventListener('mouseleave', function() {
                        mapTooltip.classList.remove('visible');
                    });
                    
                    point.addEventListener('click', function() {
                        // Filtrar eventos por área al hacer clic
                        currentFilter = 'all';
                        document.querySelectorAll('.filter-button').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.filter === 'all');
                        });
                        
                        // Buscar eventos en esta área
                        const areaEvents = eventData.filter(e => e.location && e.location.area === event.location.area);
                        if (areaEvents.length > 0) {
                            const filteredData = areaEvents;
                            renderCustomTimeline(filteredData, `Eventos en ${event.location.area}`);
                        }
                    });
                    
                    mapPointsContainer.appendChild(point);
                });
            }

            function renderCustomTimeline(events, title) {
                if (events.length === 0) {
                    timelineContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay eventos para este filtro.</p>`;
                    return;
                }

                timelineContainer.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">${title}</h3>
                        <button id="reset-filter" class="text-sm text-blue-500 hover:text-blue-700">Ver todos los eventos</button>
                    </div>
                    ${events.map(event => `
                        <div class="flex gap-4 timeline-event">
                            <div class="text-right w-20 flex-shrink-0">
                                <p class="font-bold text-sm text-blue-600">${formatTime(event.timestamp_local)}</p>
                                <p class="text-xs text-gray-500">${new Date(event.timestamp_local).toLocaleDateString('es-MX', { day: '2-digit', month: 'short' })}</p>
                            </div>
                            <div class="relative w-full">
                                <div class="absolute top-1 left-[-22px] w-4 h-4 rounded-full bg-white border-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'}"></div>
                                <div class="border-l-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'} pl-6 pb-4">
                                    <p class="font-semibold">${event.headline} ${event.social_platform ? getSocialBadge(event.social_platform) : ''}</p>
                                    <p class="text-sm text-gray-600 mt-1">${event.summary_120w}</p>
                                    <p class="text-xs text-gray-500 mt-2">Fuente: 
                                        <a href="${event.source_url}" target="_blank" class="source-link">${event.source_name}</a> 
                                        <span class="uppercase font-bold">${event.source_type}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                `;

                // Añadir event listener al botón de reset
                document.getElementById('reset-filter').addEventListener('click', () => {
                    renderTimeline('all');
                    filterButtonsContainer.querySelector('.active').classList.remove('active');
                    filterButtonsContainer.querySelector('[data-filter="all"]').classList.add('active');
                });
            }

            // --- Funciones de Exportación ---
            function downloadFile(filename, content, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function exportToTXT() {
                let txtData = "Reporte de Vigilancia Basada en Eventos (VBE)\n";
                txtData += "=================================================\n\n";
                
                eventData.forEach((event, index) => {
                    txtData += `Notificación: ${event.headline}\n`;
                    txtData += `Área que emite: Monitoreo Estatal\n\n`;
                    txtData += `${event.summary_120w}\n\n`;
                    
                    if (event.antecedentes) {
                        txtData += `Antecedentes:\n`;
                        txtData += `- ${event.antecedentes}\n\n`;
                    }
                    
                    if (event.situacion_actual) {
                        txtData += `Descripción de la situación actual:\n`;
                        txtData += `- ${event.situacion_actual}\n\n`;
                    }
                    
                    if (event.acciones_realizadas) {
                        txtData += `Acciones realizadas:\n`;
                        txtData += `- ${event.acciones_realizadas}\n\n`;
                    }
                    
                    if (event.acciones_pendientes) {
                        txtData += `Acciones por realizar:\n`;
                        txtData += `- ${event.acciones_pendientes}\n\n`;
                    }
                    
                    txtData += `Fuente: ${event.source_name} (${event.source_type})\n`;
                    txtData += `Enlace: ${event.source_url}\n`;
                    txtData += `Fecha: ${new Date(event.timestamp_local).toLocaleDateString('es-MX')}\n`;
                    txtData += `Hora: ${formatTime(event.timestamp_local)}\n`;
                    txtData += "=================================================\n\n";
                });
                
                downloadFile('monitoreo_eventos.txt', txtData, 'text/plain');
            }

            function exportToPDF() {
                // Usar jsPDF para generar PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let y = 15;
                let page = 1;
                
                eventData.forEach((event, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 15;
                        page++;
                    }
                    
                    // Título
                    doc.setFontSize(16);
                    doc.setTextColor(0, 0, 0);
                    doc.text("Reporte de Vigilancia Basada en Eventos (VBE)", 105, y, { align: 'center' });
                    y += 10;
                    
                    // Línea separadora
                    doc.setDrawColor(0, 0, 0);
                    doc.line(20, y, 190, y);
                    y += 5;
                    
                    // Nombre del evento
                    doc.setFontSize(14);
                    doc.text(`Notificación: ${event.headline}`, 20, y);
                    y += 8;
                    
                    // Área que emite
                    doc.setFontSize(12);
                    doc.text(`Área que emite: Monitoreo Estatal`, 20, y);
                    y += 8;
                    
                    // Descripción
                    const splitSummary = doc.splitTextToSize(event.summary_120w, 170);
                    doc.text(splitSummary, 20, y);
                    y += (splitSummary.length * 6) + 5;
                    
                    // Antecedentes
                    if (event.antecedentes) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text("Antecedentes:", 20, y);
                        y += 6;
                        
                        doc.setFontSize(11);
                        const splitAntecedentes = doc.splitTextToSize(`- ${event.antecedentes}`, 170);
                        doc.text(splitAntecedentes, 20, y);
                        y += (splitAntecedentes.length * 5) + 3;
                    }
                    
                    // Situación actual
                    if (event.situacion_actual) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text("Descripción de la situación actual:", 20, y);
                        y += 6;
                        
                        doc.setFontSize(11);
                        const splitSituacion = doc.splitTextToSize(`- ${event.situacion_actual}`, 170);
                        doc.text(splitSituacion, 20, y);
                        y += (splitSituacion.length * 5) + 3;
                    }
                    
                    // Acciones realizadas
                    if (event.acciones_realizadas) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text("Acciones realizadas:", 20, y);
                        y += 6;
                        
                        doc.setFontSize(11);
                        const splitAcciones = doc.splitTextToSize(`- ${event.acciones_realizadas}`, 170);
                        doc.text(splitAcciones, 20, y);
                        y += (splitAcciones.length * 5) + 3;
                    }
                    
                    // Acciones por realizar
                    if (event.acciones_pendientes) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text("Acciones por realizar:", 20, y);
                        y += 6;
                        
                        doc.setFontSize(11);
                        const splitPendientes = doc.splitTextToSize(`- ${event.acciones_pendientes}`, 170);
                        doc.text(splitPendientes, 20, y);
                        y += (splitPendientes.length * 5) + 3;
                    }
                    
                    // Fuente
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Fuente: ${event.source_name} (${event.source_type}) | Enlace: ${event.source_url}`, 20, y);
                    y += 5;
                    
                    doc.text(`Fecha: ${new Date(event.timestamp_local).toLocaleDateString('es-MX')} | Hora: ${formatTime(event.timestamp_local)}`, 20, y);
                    y += 10;
                    
                    // Línea separadora
                    doc.setDrawColor(200, 200, 200);
                    doc.line(20, y, 190, y);
                    y += 10;
                });
                
                doc.save('monitoreo_eventos.pdf');
            }

            // --- Event Listeners ---
            filterButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-button')) {
                    filterButtonsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    renderTimeline(e.target.dataset.filter);
                }
            });

            alertButton.addEventListener('click', () => {
                renderAlerts();
                alertsModal.classList.remove('hidden');
                alertsModal.classList.add('flex');
            });
            
            modalClose.addEventListener('click', () => alertsModal.classList.add('hidden'));
            
            // Cerrar modal al hacer clic fuera del contenido
            alertsModal.addEventListener('click', (e) => {
                if (e.target === alertsModal) {
                    alertsModal.classList.add('hidden');
                }
            });
            
            // Exportación de datos
            exportTxtBtn.addEventListener('click', exportToTXT);
            exportPdfBtn.addEventListener('click', exportToPDF);

            // --- Inicialización ---
            function init() {
                const now = new Date();
                const options = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: TIMEZONE };
                lastUpdateTime.textContent = now.toLocaleTimeString('es-MX', options);
                
                renderTimeline();
                renderSummary();
                renderTicker();
                renderAlerts();
                renderMap();
            }

            init();
        });
    </script>
</body>
</html>
