<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo de Emergencias en Sonora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .risk-light {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            transition: background-color 0.5s ease-in-out;
        }
        .risk-low { background-color: #4ade80; }
        .risk-medium { background-color: #facc15; }
        .risk-high { background-color: #f87171; }
        .filter-button.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Estilos adicionales para mejorar la apariencia */
        .timeline-event {
            transition: all 0.3s ease;
        }
        .timeline-event:hover {
            transform: translateX(5px);
        }
        #map-container {
            position: relative;
            overflow: hidden;
        }
        .map-point {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        .map-point.risk-high {
            background-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
        }
        .map-point.risk-medium {
            background-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
        }
        .map-point.risk-low {
            background-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-600">Panel de Monitoreo de Emergencias</h1>
            <p class="text-lg text-gray-600 mt-2">Situación Actual en Sonora, México</p>
            <p class="text-sm text-gray-500 mt-1">Última actualización: <span id="last-update-time">--:--:--</span></p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Columna Principal (Izquierda) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Sección de Resumen y Riesgo -->
                <section class="card p-6">
                    <h2 class="text-2xl font-bold border-b-2 border-gray-100 pb-3 mb-4">Situación General</h2>
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <!-- Semáforo de Riesgo -->
                        <div class="text-center w-full md:w-1/4">
                             <h3 class="font-semibold text-gray-700 mb-2">Riesgo en Salud Pública</h3>
                             <div id="risk-light" class="risk-light risk-high mx-auto shadow-inner"></div>
                             <p id="risk-text" class="font-bold text-lg mt-2 capitalize">High</p>
                        </div>
                        <!-- Resumen Ejecutivo -->
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-700 mb-2">Resumen Ejecutivo</h3>
                            <p id="executive-summary" class="text-gray-600">Situación crítica con impacto severo. Hay evacuaciones activas y riesgos significativos para la salud pública. Se requiere máxima precaución y atención a las directivas de las autoridades.</p>
                        </div>
                    </div>
                     <div class="mt-6 text-right">
                        <button id="alert-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                            Ver Alertas Críticas (<span id="alert-count">3</span>)
                        </button>
                    </div>
                </section>

                <!-- Cronología de Eventos -->
                <section class="card p-6">
                    <div class="flex flex-wrap justify-between items-center border-b-2 border-gray-100 pb-3 mb-4">
                         <h2 class="text-2xl font-bold">Cronología de Eventos</h2>
                         <div id="filter-buttons" class="flex flex-wrap gap-2 mt-2 md:mt-0">
                            <button class="filter-button active px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="all">Todos</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="official">Oficial</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="healthcare">Salud</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="infrastructure">Infraestructura</button>
                         </div>
                    </div>
                    <div id="timeline-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        <!-- Los eventos se insertarán aquí dinámicamente -->
                    </div>
                </section>
            </div>

            <!-- Columna Secundaria (Derecha) -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Ticker de Novedades -->
                <section class="card p-6">
                     <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Últimas Novedades Verificadas</h2>
                     <div id="ticker-list" class="space-y-3 max-h-48 overflow-y-auto pr-2 text-sm">
                        <!-- El ticker se llenará aquí -->
                     </div>
                </section>

                <!-- Mapa de Impacto -->
                <section class="card p-6">
                    <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Mapa de Impacto</h2>
                    <div id="map-container" class="bg-gray-200 rounded-lg h-64 flex items-center justify-center text-center text-gray-500 relative">
                        <!-- Puntos del mapa representando eventos -->
                        <div class="map-point risk-high" style="top: 30%; left: 40%;" title="Hermosillo Norte - Lluvias intensas"></div>
                        <div class="map-point risk-medium" style="top: 45%; left: 35%;" title="Mirasoles - Inundaciones"></div>
                        <div class="map-point risk-high" style="top: 50%; left: 45%;" title="La Caridad - Evacuaciones"></div>
                        <div class="map-point risk-high" style="top: 60%; left: 50%;" title="Centro - Refugios"></div>
                        <div class="map-point risk-high" style="top: 70%; left: 55%;" title="Hermosillo Sur - Alerta sanitaria"></div>
                        
                        <div id="map-placeholder">
                            <p class="font-semibold">Mapa Interactivo</p>
                            <p class="text-xs mt-1">(Visualización de zonas afectadas, albergues e infraestructura crítica)</p>
                        </div>
                    </div>
                </section>

                 <!-- Exportar Datos -->
                 <section class="card p-6">
                    <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Exportar Datos</h2>
                    <p class="text-sm text-gray-600 mb-4">Descargue el registro completo de eventos para su análisis.</p>
                    <div class="flex flex-col space-y-2">
                        <button id="export-json" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-sm">Exportar a JSON</button>
                        <button id="export-csv" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-sm">Exportar a CSV</button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal para Alertas -->
    <div id="alerts-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="card p-6 rounded-lg max-w-lg w-full max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-2xl font-bold text-red-600">Alertas Críticas</h2>
                <button id="modal-close" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="overflow-y-auto max-h-[calc(90vh-8rem)] space-y-4">
                <!-- Contenido de las alertas se inserta aquí -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const TIMEZONE = 'America/Hermosillo';

            // --- Mock Data ---
            const eventData = [
                {
                    "id": "evt001", 
                    "timestamp_local": "2025-09-03T02:00:00-07:00", 
                    "source_type": "official", 
                    "source_name": "SMN/CONAGUA", 
                    "topic": "rain",
                    "headline": "Lluvias intensas registran acumulado de 83 mm en Hermosillo", 
                    "summary_120w": "El Servicio Meteorológico Nacional reporta lluvias torrenciales durante la madrugada, con un acumulado de 83 milímetros en la zona norte de Hermosillo, superando los pronósticos iniciales.",
                    "verification": "verified", 
                    "public_health_risk": "medium", 
                    "change_flag": false
                },
                {
                    "id": "evt002", 
                    "timestamp_local": "2025-09-03T04:30:00-07:00", 
                    "source_type": "media", 
                    "source_name": "El Imparcial", 
                    "topic": "infrastructure",
                    "headline": "Inundaciones severas en colonias Mirasoles, Bachoco y La Caridad", 
                    "summary_120w": "Medios locales informan de inundaciones significativas y arrastre de vehículos en varias colonias del norte de la ciudad. Se reportan cortes de energía y caída de árboles.",
                    "verification": "verified", 
                    "public_health_risk": "medium", 
                    "change_flag": false
                },
                {
                    "id": "evt003", 
                    "timestamp_local": "2025-09-03T07:00:00-07:00", 
                    "source_type": "official", 
                    "source_name": "Ayuntamiento de Hermosillo", 
                    "topic": "evacuation",
                    "headline": "Evalúan evacuación de 40 familias en la colonia La Caridad", 
                    "summary_120w": "Autoridades municipales informan que 40 viviendas en La Caridad sufrieron daños por inundación. Se está analizando el traslado de los afectados a refugios temporales.",
                    "verification": "verified", 
                    "public_health_risk": "high", 
                    "change_flag": true
                },
                {
                    "id": "evt004", 
                    "timestamp_local": "2025-09-03T08:15:00-07:00", 
                    "source_type": "official", 
                    "source_name": "Protección Civil Sonora", 
                    "topic": "shelters",
                    "headline": "Habilitan 5 refugios temporales en Hermosillo", 
                    "summary_120w": "Se habilitan oficialmente los Centros Hábitat, Solidaridad 1, Minitas, Casa Galilea y Miguel Alemán como refugios temporales para recibir a las familias afectadas por las inundaciones.",
                    "verification": "verified", 
                    "public_health_risk": "high", 
                    "change_flag": true
                },
                {
                    "id": "evt005", 
                    "timestamp_local": "2025-09-03T09:00:00-07:00", 
                    "source_type": "official", 
                    "source_name": "Secretaría de Salud Sonora", 
                    "topic": "healthcare",
                    "headline": "Emiten alerta sanitaria por riesgos tras inundaciones", 
                    "summary_120w": "La Secretaría de Salud emite recomendaciones para prevenir enfermedades diarreicas y transmitidas por vector (dengue). Se pide a la población clorar el agua, manejar adecuadamente los residuos y evitar el contacto con aguas estancadas.",
                    "verification": "verified", 
                    "public_health_risk": "high", 
                    "change_flag": true
                }
            ].sort((a, b) => new Date(b.timestamp_local) - new Date(a.timestamp_local));

            // --- Elementos del DOM ---
            const lastUpdateTime = document.getElementById('last-update-time');
            const riskLight = document.getElementById('risk-light');
            const riskText = document.getElementById('risk-text');
            const executiveSummary = document.getElementById('executive-summary');
            const timelineContainer = document.getElementById('timeline-container');
            const filterButtonsContainer = document.getElementById('filter-buttons');
            const tickerList = document.getElementById('ticker-list');
            const alertButton = document.getElementById('alert-button');
            const alertCount = document.getElementById('alert-count');
            const alertsModal = document.getElementById('alerts-modal');
            const modalClose = document.getElementById('modal-close');
            const modalBody = document.getElementById('modal-body');
            const exportJsonBtn = document.getElementById('export-json');
            const exportCsvBtn = document.getElementById('export-csv');

            // --- Funciones de Renderizado ---
            function formatTime(isoString) {
                const options = { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: TIMEZONE };
                return new Date(isoString).toLocaleTimeString('es-MX', options);
            }

            function renderTimeline(filter = 'all') {
                let filteredData = eventData;
                if (filter !== 'all') {
                    filteredData = eventData.filter(event => event.source_type === filter || event.topic === filter);
                }

                if (filteredData.length === 0) {
                    timelineContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay eventos para este filtro.</p>`;
                    return;
                }

                timelineContainer.innerHTML = filteredData.map(event => `
                    <div class="flex gap-4 timeline-event">
                        <div class="text-right w-20 flex-shrink-0">
                            <p class="font-bold text-sm text-blue-600">${formatTime(event.timestamp_local)}</p>
                            <p class="text-xs text-gray-500">${new Date(event.timestamp_local).toLocaleDateString('es-MX', { day: '2-digit', month: 'short' })}</p>
                        </div>
                        <div class="relative w-full">
                            <div class="absolute top-1 left-[-22px] w-4 h-4 rounded-full bg-white border-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'}"></div>
                            <div class="border-l-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'} pl-6 pb-4">
                                <p class="font-semibold">${event.headline}</p>
                                <p class="text-sm text-gray-600 mt-1">${event.summary_120w}</p>
                                <p class="text-xs text-gray-500 mt-2">Fuente: ${event.source_name} <span class="uppercase font-bold">${event.source_type}</span></p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function renderSummary() {
                const latestRisk = eventData[0]?.public_health_risk || 'low';
                
                riskLight.classList.remove('risk-low', 'risk-medium', 'risk-high');
                riskLight.classList.add(`risk-${latestRisk}`);
                riskText.textContent = latestRisk;
                
                const summaryText = {
                    low: "La situación está controlada. El impacto es menor y los servicios operan con normalidad. Se mantiene monitoreo preventivo.",
                    medium: "Impacto moderado en infraestructura y servicios. Existen riesgos sanitarios localizados. Se recomienda a la población mantenerse informada y seguir indicaciones.",
                    high: "Situación crítica con impacto severo. Hay evacuaciones activas y riesgos significativos para la salud pública. Se requiere máxima precaución y atención a las directivas de las autoridades."
                };
                executiveSummary.textContent = summaryText[latestRisk];
            }
            
            function renderTicker() {
                const verifiedEvents = eventData.filter(e => e.verification === 'verified').slice(0, 5);
                if (verifiedEvents.length === 0) {
                    tickerList.innerHTML = '<p class="text-gray-500 text-center py-4">No hay novedades verificadas recientemente.</p>';
                    return;
                }
                
                tickerList.innerHTML = verifiedEvents.map(event => `
                    <div class="fade-in">
                        <p class="font-semibold truncate">${event.headline}</p>
                        <p class="text-xs text-gray-500">${event.source_name} - ${formatTime(event.timestamp_local)}</p>
                    </div>
                `).join('<hr class="my-2">');
            }

            function renderAlerts() {
                const criticalAlerts = eventData.filter(e => e.change_flag);
                alertCount.textContent = criticalAlerts.length;
                
                if (criticalAlerts.length === 0) {
                    modalBody.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p>No hay alertas críticas en este momento.</p>
                        </div>
                    `;
                    return;
                }
                
                modalBody.innerHTML = criticalAlerts.map(alert => `
                    <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded fade-in">
                        <p class="font-bold">${alert.headline}</p>
                        <p class="text-sm mt-1">${alert.summary_120w}</p>
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-xs text-gray-500">Registrado a las ${formatTime(alert.timestamp_local)}</p>
                        </div>
                    </div>
                `).join('');
            }

            // --- Event Listeners ---
            filterButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-button')) {
                    filterButtonsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    renderTimeline(e.target.dataset.filter);
                }
            });

            alertButton.addEventListener('click', () => {
                renderAlerts();
                alertsModal.classList.remove('hidden');
                alertsModal.classList.add('flex');
            });
            
            modalClose.addEventListener('click', () => alertsModal.classList.add('hidden'));
            
            // Cerrar modal al hacer clic fuera del contenido
            alertsModal.addEventListener('click', (e) => {
                if (e.target === alertsModal) {
                    alertsModal.classList.add('hidden');
                }
            });
            
            function downloadFile(filename, content, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            exportJsonBtn.addEventListener('click', () => {
                const jsonData = JSON.stringify(eventData, null, 2);
                downloadFile('monitoreo_eventos.json', jsonData, 'application/json');
            });

            exportCsvBtn.addEventListener('click', () => {
                const headers = "id,timestamp_local,source_type,source_name,topic,headline,summary_120w,verification,public_health_risk,change_flag";
                const rows = eventData.map(e => `"${e.id}","${e.timestamp_local}","${e.source_type}","${e.source_name}","${e.topic}","${e.headline.replace(/"/g, '""')}","${e.summary_120w.replace(/"/g, '""')}","${e.verification}","${e.public_health_risk}",${e.change_flag}`);
                const csvData = `${headers}\n${rows.join('\n')}`;
                downloadFile('monitoreo_eventos.csv', csvData, 'text/csv;charset=utf-8;');
            });

            // --- Inicialización ---
            function init() {
                const now = new Date();
                const options = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: TIMEZONE };
                lastUpdateTime.textContent = now.toLocaleTimeString('es-MX', options);
                
                renderTimeline();
                renderSummary();
                renderTicker();
                renderAlerts();
            }

            init();
        });
    </script>
</body>
</html>
