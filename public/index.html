<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo de Emergencias en Sonora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .risk-light {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            transition: all 0.5s ease-in-out;
        }
        .risk-low { 
            background-color: #4ade80; 
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }
        .risk-medium { 
            background-color: #facc15; 
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.5);
        }
        .risk-high { 
            background-color: #f87171; 
            box-shadow: 0 0 10px rgba(248, 113, 113, 0.5);
        }
        .filter-button.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Estilos para el mapa */
        #map-container {
            height: 300px;
            border-radius: 0.5rem;
            z-index: 1;
        }
        
        /* Animaciones */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* Mejoras visuales */
        .source-link {
            color: #3b82f6;
            text-decoration: underline;
        }
        .source-link:hover {
            color: #2563eb;
        }
        .export-button {
            transition: all 0.3s ease;
        }
        .export-button:hover {
            transform: translateY(-2px);
        }
        .social-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 6px;
        }
        .facebook { background-color: #1877f2; color: white; }
        .twitter { background-color: #1da1f2; color: white; }
        .instagram { background-color: #e4405f; color: white; }
        .tiktok { background-color: #000000; color: white; }
        .news { background-color: #dc2626; color: white; }
        .official { background-color: #059669; color: white; }
        
        .leaflet-popup-content {
            font-size: 14px;
            line-height: 1.5;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }

        /* Estilos para mensajes de error */
        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f87171;
            color: white;
            padding: 12px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            display: none;
        }

        /* Estilos para loading */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-600">Panel de Monitoreo de Emergencias</h1>
            <p class="text-lg text-gray-600 mt-2">Situación Actual en Sonora, México</p>
            <p class="text-sm text-gray-500 mt-1">Última actualización: <span id="last-update-time">--:--:--</span></p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Columna Principal (Izquierda) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Sección de Resumen y Riesgo -->
                <section class="card p-6">
                    <h2 class="text-2xl font-bold border-b-2 border-gray-100 pb-3 mb-4">Situación General</h2>
                    <div class="flex flex-col md:flex-row gap-6 items-start">
                        <!-- Semáforo de Riesgo -->
                        <div class="text-center w-full md:w-1/4">
                             <h3 class="font-semibold text-gray-700 mb-2">Riesgo en Salud Pública</h3>
                             <div id="risk-light" class="risk-light risk-high mx-auto shadow-inner pulse"></div>
                             <p id="risk-text" class="font-bold text-lg mt-2 capitalize">Alto</p>
                        </div>
                        <!-- Resumen Ejecutivo -->
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-700 mb-2">Resumen Ejecutivo</h2>
                            <p id="executive-summary" class="text-gray-600">Cargando datos en tiempo real...</p>
                        </div>
                    </div>
                     <div class="mt-6 text-right">
                        <button id="alert-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                            Ver Alertas Críticas (<span id="alert-count">0</span>)
                        </button>
                    </div>
                </section>

                <!-- Cronología de Eventos -->
                <section class="card p-6">
                    <div class="flex flex-wrap justify-between items-center border-b-2 border-gray-100 pb-3 mb-4">
                         <h2 class="text-2xl font-bold">Cronología de Eventos</h2>
                         <div id="filter-buttons" class="flex flex-wrap gap-2 mt-2 md:mt-0">
                            <button class="filter-button active px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="all">Todos</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="official">Oficial</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="social">Redes Sociales</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="healthcare">Salud</button>
                            <button class="filter-button px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-gray-300 transition" data-filter="infrastructure">Infraestructura</button>
                         </div>
                    </div>
                    <div id="timeline-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        <div class="text-center py-8">
                            <div class="loading-spinner"></div>
                            <p class="text-gray-500 mt-2">Cargando eventos...</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Columna Secundaria (Derecha) -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Ticker de Novedades -->
                <section class="card p-6">
                     <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Últimas Novedades Verificadas</h2>
                     <div id="ticker-list" class="space-y-3 max-h-48 overflow-y-auto pr-2 text-sm">
                        <div class="text-center py-4">
                            <p class="text-gray-500">Cargando novedades...</p>
                        </div>
                     </div>
                </section>

                <!-- Mapa de Impacto -->
                <section class="card p-6">
                    <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Mapa de Impacto</h2>
                    <div id="map-container" class="rounded-lg"></div>
                </section>

                 <!-- Exportar Datos -->
                 <section class="card p-6">
                    <h2 class="text-xl font-bold border-b-2 border-gray-100 pb-2 mb-3">Exportar Datos</h2>
                    <p class="text-sm text-gray-600 mb-4">Generar reporte de vigilancia basado en eventos (VBE).</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="export-doc" class="export-button bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-sm">DOC</button>
                        <button id="export-pdf" class="export-button bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 text-sm">PDF</button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal para Alertas -->
    <div id="alerts-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="card p-6 rounded-lg max-w-lg w-full max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-2xl font-bold text-red-600">Alertas Críticas</h2>
                <button id="modal-close" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="overflow-y-auto max-h-[calc(90vh-8rem)] space-y-4">
                <div class="text-center py-8">
                    <p class="text-gray-500">Cargando alertas...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const TIMEZONE = 'America/Hermosillo';
            let map = null;
            let markers = [];
            
            // Inicializar el mapa
            function initMap() {
                map = L.map('map-container').setView([29.0892, -110.9613], 10);
                
                // Añadir capa de OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Añadir marcadores iniciales (se actualizarán con datos reales)
                addMarkersToMap([]);
            }
            
            // Añadir marcadores al mapa
            function addMarkersToMap(events) {
                // Limpiar marcadores existentes
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                
                // Añadir nuevos marcadores
                events.filter(event => event.lat && event.lng).forEach(event => {
                    const riskColors = {
                        'high': 'red',
                        'medium': 'orange',
                        'low': 'green'
                    };
                    
                    const marker = L.marker([event.lat, event.lng], {
                        icon: L.divIcon({
                            className: `custom-marker risk-${event.public_health_risk}`,
                            html: `<div style="background-color: ${riskColors[event.public_health_risk]}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                    
                    marker.addTo(map).bindPopup(`
                        <div class="font-semibold">${event.headline}</div>
                        <div class="text-sm mt-1">${event.summary_120w}</div>
                        <div class="text-xs mt-2">Fuente: <a href="${event.source_url}" target="_blank" class="text-blue-500">${event.source_name}</a></div>
                        <div class="text-xs">Área: ${event.area || 'No especificada'}</div>
                    `);
                    
                    markers.push(marker);
                });
            }
            
            // Obtener datos reales de emergencias desde el backend
            async function fetchEmergencyData() {
                try {
                    // URL del backend en Render
                    const backendUrl = 'https://monson.onrender.com/api/events';
                    
                    const response = await fetch(backendUrl);
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log(`Datos recibidos del backend: ${data.length} eventos`);
                    return data;
                } catch (error) {
                    console.error("Error obteniendo datos de emergencia:", error);
                    
                    // Mostrar mensaje de error
                    showErrorMessage("No se pudieron cargar los datos en tiempo real. Verifica la conexión al backend.");
                    
                    // Devolver array vacío en lugar de datos simulados
                    return [];
                }
            }
            
            // Función para mostrar mensajes de error
            function showErrorMessage(message) {
                // Crear o mostrar un elemento de error en la interfaz
                let errorElement = document.getElementById('error-message');
                if (!errorElement) {
                    errorElement = document.createElement('div');
                    errorElement.id = 'error-message';
                    errorElement.className = 'error-message';
                    document.body.appendChild(errorElement);
                }
                
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                
                // Ocultar después de 5 segundos
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }

            // --- Elementos del DOM ---
            const lastUpdateTime = document.getElementById('last-update-time');
            const riskLight = document.getElementById('risk-light');
            const riskText = document.getElementById('risk-text');
            const executiveSummary = document.getElementById('executive-summary');
            const timelineContainer = document.getElementById('timeline-container');
            const filterButtonsContainer = document.getElementById('filter-buttons');
            const tickerList = document.getElementById('ticker-list');
            const alertButton = document.getElementById('alert-button');
            const alertCount = document.getElementById('alert-count');
            const alertsModal = document.getElementById('alerts-modal');
            const modalClose = document.getElementById('modal-close');
            const modalBody = document.getElementById('modal-body');
            const exportDocBtn = document.getElementById('export-doc');
            const exportPdfBtn = document.getElementById('export-pdf');

            // --- Funciones de Renderizado ---
            function formatTime(isoString) {
                const options = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: TIMEZONE };
                return new Date(isoString).toLocaleTimeString('es-MX', options);
            }

            function getSocialBadge(platform) {
                if (!platform) return '';
                return `<span class="social-badge ${platform}">${platform.toUpperCase()}</span>`;
            }

            function renderTimeline(events, filter = 'all') {
                let filteredData = events;
                if (filter !== 'all') {
                    if (filter === 'social') {
                        filteredData = events.filter(event => event.source_type === 'social');
                    } else {
                        filteredData = events.filter(event => event.source_type === filter || event.topic === filter);
                    }
                }

                if (filteredData.length === 0) {
                    timelineContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay eventos para este filtro.</p>`;
                    return;
                }

                timelineContainer.innerHTML = filteredData.map(event => `
                    <div class="flex gap-4 timeline-event">
                        <div class="text-right w-20 flex-shrink-0">
                            <p class="font-bold text-sm text-blue-600">${formatTime(event.timestamp)}</p>
                            <p class="text-xs text-gray-500">${new Date(event.timestamp).toLocaleDateString('es-MX', { day: '2-digit', month: 'short' })}</p>
                        </div>
                        <div class="relative w-full">
                            <div class="absolute top-1 left-[-22px] w-4 h-4 rounded-full bg-white border-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'}"></div>
                            <div class="border-l-2 ${event.change_flag ? 'border-red-500' : 'border-blue-500'} pl-6 pb-4">
                                <p class="font-semibold">${event.headline} ${event.social_platform ? getSocialBadge(event.social_platform) : ''}</p>
                                <p class="text-sm text-gray-600 mt-1">${event.summary_120w}</p>
                                <p class="text-xs text-gray-500 mt-2">Fuente: 
                                    <a href="${event.source_url}" target="_blank" class="source-link">${event.source_name}</a> 
                                    <span class="uppercase font-bold ${event.source_type} social-badge">${event.source_type}</span>
                                </p>
                                <button class="mt-2 px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 generate-report" data-id="${event.id}">
                                    Generar Reporte VBE
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Añadir event listeners para los botones de generar reporte
                document.querySelectorAll('.generate-report').forEach(button => {
                    button.addEventListener('click', function() {
                        const eventId = this.dataset.id;
                        const event = events.find(e => e.id === eventId);
                        if (event) {
                            generateReport(event);
                        }
                    });
                });
            }

            function renderSummary(events) {
                if (events.length === 0) {
                    riskLight.classList.remove('risk-low', 'risk-medium', 'risk-high', 'pulse');
                    riskText.textContent = 'Sin datos';
                    executiveSummary.textContent = 'Esperando datos para generar un resumen ejecutivo...';
                    return;
                }

                // Calcular el riesgo más alto
                const riskLevels = { 'low': 0, 'medium': 1, 'high': 2 };
                let highestRisk = 'low';
                
                events.forEach(event => {
                    if (riskLevels[event.public_health_risk] > riskLevels[highestRisk]) {
                        highestRisk = event.public_health_risk;
                    }
                });
                
                riskLight.classList.remove('risk-low', 'risk-medium', 'risk-high', 'pulse');
                riskLight.classList.add(`risk-${highestRisk}`);
                
                // Hacer parpadear el semáforo si el riesgo es alto
                if (highestRisk === 'high') {
                    riskLight.classList.add('pulse');
                }
                
                riskText.textContent = highestRisk === 'high' ? 'Alto' : highestRisk === 'medium' ? 'Medio' : 'Bajo';
                
                const summaryText = {
                    low: "La situación está controlada. El impacto es menor y los servicios operan con normalidad. Se mantiene monitoreo preventivo.",
                    medium: "Impacto moderado en infraestructura y servicios. Existen riesgos sanitarios localizados. Se recomienda a la población mantenerse informada y seguir indicaciones.",
                    high: "Situación crítica con impacto severo. Hay evacuaciones activas y riesgos significativos para la salud pública. Se requiere máxima precaución y atención a las directivas de las autoridades."
                };
                executiveSummary.textContent = summaryText[highestRisk];
            }
            
            function renderTicker(events) {
                const verifiedEvents = events.filter(e => e.verification === 'verified' || e.source_type === 'official').slice(0, 5);
                if (verifiedEvents.length === 0) {
                    tickerList.innerHTML = '<p class="text-gray-500 text-center py-4">No hay novedades verificadas recientemente.</p>';
                    return;
                }
                
                tickerList.innerHTML = verifiedEvents.map(event => `
                    <div class="fade-in">
                        <p class="font-semibold truncate">${event.headline}</p>
                        <p class="text-xs text-gray-500">${event.source_name} - ${formatTime(event.timestamp)}</p>
                    </div>
                `).join('<hr class="my-2">');
            }

            function renderAlerts(events) {
                const criticalAlerts = events.filter(e => e.change_flag);
                alertCount.textContent = criticalAlerts.length;
                
                if (criticalAlerts.length === 0) {
                    modalBody.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p>No hay alertas críticas en este momento.</p>
                        </div>
                    `;
                    return;
                }
                
                modalBody.innerHTML = criticalAlerts.map(alert => `
                    <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded fade-in">
                        <p class="font-bold">${alert.headline}</p>
                        <p class="text-sm mt-1">${alert.summary_120w}</p>
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-xs text-gray-500">Registrado a las ${formatTime(alert.timestamp)}</p>
                            ${alert.area ? `<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">${alert.area}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            // Generar reporte en formato DOC
            function generateDocReport(event) {
                const reportContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                          xmlns:w='urn:schemas-microsoft-com:office:word' 
                          xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset="UTF-8">
                        <title>Reporte de Vigilancia Basada en Eventos (VBE)</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 0 auto; padding: 20px; max-width: 800px; }
                            h1 { color: #003366; font-size: 1.5rem; margin-bottom: 0; text-align: center; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .date { font-size: 0.8rem; color: #6b7280; }
                            hr { border: none; border-top: 1px solid #e5e7eb; margin: 20px 0; }
                            h2 { font-size: 1.2rem; font-weight: bold; color: #1f2937; }
                            h3 { font-size: 1.1rem; font-weight: bold; color: #1f2937; margin-top: 20px; }
                            p { font-size: 1rem; color: #374151; margin-top: 5px; }
                            .footer { margin-top: 30px; font-size: 0.8rem;
